#!/bin/sh
#
# run
#
# David Adams
# November 2015
# Generate a sample

HELP=
CLEAN=
DBG=
while getopts hcd: OPT; do
  case $OPT in
  h) HELP=true;;
  c) CLEAN=true;;
  d) DBG=$OPTARG;;
  esac
done
shift $(( OPTIND-1 ))
SAMGEN=$1
SAMDET=$2
SAMSIM=$3
SAMPLE=${SAMGEN}${SAMDET}${SAMSIM}

if [ -n "$CLEAN" ]; then
  rm -f ${SAMPLE}_hist.root ${SAMPLE}_event.root ${SAMPLE}.log
  rm -f ${SAMPLE}perf.root ${SAMPLE}perf.log
fi

if [ ! -r ${SAMPLE}.fcl ]; then
  FCLGEN=fcl/$SAMGEN.fcl
  FCLDET=fcl/$SAMDET.fcl
  FCLSIM=fcl/$SAMSIM.fcl
  # Create fcl file.
  rm -f ${SAMPLE}_event.root
  if [ ! -r $FCLGEN ]; then
    echo Unable to find generator fcl: $FCLGEN
    exit 1
  fi
  if [ ! -r $FCLDET ]; then
    echo Unable to find detector fcl: $FCLDET
    exit 1
  fi
  if [ ! -r $FCLSIM ]; then
    echo Unable to find simulation fcl: $FCLSIM
    exit 1
  fi
  cat  $FCLDET $FCLGEN $FCLSIM > $SAMPLE.fcl
  echo Created fcl $SAMPLE.fcl
fi

# Generate event data.
if [ ! -r ${SAMPLE}_event.root ]; then
  rm -f ${SAMPLE}perf.root
  echo
  echo run: Generating event data.
  echo " Start: "`date`
  COM="lar -n 5 -c ${SAMPLE}.fcl -T ${SAMPLE}_hist.root -o ${SAMPLE}_event.root"
  echo $COM >${SAMPLE}.log
  $COM 2>&1 >> ${SAMPLE}.log
  STAT=$?
  echo Finish: `date`
  if [ $STAT -ne 0 -o ! -r ${SAMPLE}_event.root ]; then
    echo run: Event generation failed.
    echo Log is ${SAMPLE}.log
    exit 1
  fi
  fcldump ${SAMPLE}.fcl 10 > ${SAMPLE}.fcldump
fi

# Generate histograms.
if [ ! -r ${SAMPLE}perf.root ]; then
  echo
  echo run: Generating histograms.
  echo " Start: "`date`
  FCL=fcl/perf35t.fcl
  COM="lar -c $FCL -s ${SAMPLE}_event.root -T ${SAMPLE}perf.root"
  echo $COM
  $COM 2>&1 >${SAMPLE}perf.log
  STAT=$?
  echo Finish: `date`
  if [ $STAT -ne 0 -o ! -r ${SAMPLE}perf.root ]; then
    echo run: Histogram generation failed.
    echo Log is ${SAMPLE}perf.log
    exit 1
  fi
fi
